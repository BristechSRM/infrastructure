{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters" : {
        "PublicElasticIP" : {
            "Type" : "String",
            "Description" : "The Elastic IP to associate with this stack"
        },
        "SpeakerDBClientSG" : {
            "Type" : "AWS::EC2::SecurityGroup::Id",
            "Default" : "sg-02d53065",
            "Description" : "A security group with access to the security group of the Speakers DB"
        },
        "dynamoDbSecretAccessKey" : {
            "Type" : "String",
            "Description" : "The secret access key with which speaker-comms talks to it's DB"
        },
        "dynamoDbAccessKeyId" : {
            "Type" : "String",
            "Description" : "The access key ID with which speaker-comms talks to it's DB"
        },
        "speakerServerKeyPair" : {
            "Type" : "AWS::EC2::KeyPair::KeyName",
            "Dafault" : "developmentStack",
            "Description" : "The key pair used to gain access to the EC2 instance(s) via ssh, should the need arise."
        }
    },
    "Resources": {
      	"speakersServer": {
              "Type": "AWS::EC2::Instance",
              "Properties": {
                "DisableApiTermination": "false",
                "InstanceInitiatedShutdownBehavior": "stop",
                "IamInstanceProfile": "ecsInstanceRole",
                "ImageId": "ami-76e95b05",
                "InstanceType": "t2.micro",
                "KeyName": { "Ref" : "speakerServerKeyPair"},
                "Monitoring": "false",
                "Tags": [
                    {"Key": "Name","Value": "speakersServer"},
                    {"Key": "Product","Value": "bristechSRM"},
                    {"Key": "Environment","Value": "development"},
                    {"Key": "Cluster","Value": "speakers"},
                    {"Key": "Service","Value": "speakers"},
                    {"Key": "Purpose","Value": "docker"}
                ],
                "NetworkInterfaces": [
                    {
                        "DeleteOnTermination": "true",
                        "DeviceIndex": 0,
                        "SubnetId": "subnet-b64844c1",
                        "GroupSet": [
                            {"Ref" : "SpeakerDBClientSG"},
                            "sg-b6e9d4d2"

                        ]
                    }
                ],
                "UserData" : {
                    "Fn::Base64" : {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash\n",
                                "echo ECS_CLUSTER=",
                                { "Ref": "speakersCluster" },
                                " >> /etc/ecs/ecs.config\n",
                                "mkdir /etc/speakerComms\n",
                                "echo [dynamo-db-read] >> /etc/speakerComms/credentials \n",
                                "echo aws_access_key_id = ",
                                { "Ref": "dynamoDbAccessKeyId" },
                                " >> /etc/speakerComms/credentials\n",
                                "echo aws_secret_access_key = ",
                                { "Ref": "dynamoDbSecretAccessKey" },
                                " >> /etc/speakerComms/credentials\n"
                            ]
                        ]
                    }
                }
            }
        },
        "speakersCluster": {
            "Type": "AWS::ECS::Cluster"
        },
        "speakersTaskDefinition": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties" : {
                "ContainerDefinitions" : [
                    {
                        "Name" : "speakers",
                        "Cpu" : "1",
                        "Image" : "bristechsrm/speakers:latest",
                        "Memory" : "300",
                        "PortMappings" : [
                            {"HostPort" : 80, "ContainerPort" : 9000, "Protocol" : "tcp"}
                        ]
                    }
                ]
            }
        },
        "speakerService": {
            "Type": "AWS::ECS::Service",
            "Properties" : {
                "Cluster": {"Ref": "speakersCluster"},
                "DesiredCount": "1",
                "TaskDefinition" : {"Ref":"speakersTaskDefinition"}
            }
        },
         "speakerCommsTaskDefinition": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties" : {
                "ContainerDefinitions" : [
                    {
                        "Name" : "speakerComms",
                        "Cpu" : "1",
                        "Image" : "bristechsrm/speaker-comms:latest",
                        "Memory" : "300",
                        "Environment" : [
                            {
                                "Name" : "aws_access_key_id",
                                "Value" : { "Ref" : "dynamoDbAccessKeyId"}
                            },
                            {
                                "Name" : "aws_secret_access_key",
                                "Value" : { "Ref" : "dynamoDbSecretAccessKey"}
                            }
                        ],
                        "PortMappings" : [
                            {"HostPort" : 8080, "ContainerPort" : 8080, "Protocol" : "tcp"}
                        ],
                        "MountPoints" : [
                            {
                                "ContainerPath" : "/root/.aws",
                                "SourceVolume" : "speakerCommsCredentials",
                                "ReadOnly" : true
                            }
                        ]
                    }
                ],
                "Volumes" : [
                    {
                        "Name" : "speakerCommsCredentials",
                        "Host" : {
                            "SourcePath" : "/etc/speakerComms"
                        }
                    }
                ]
            }
        },
        "speakerCommsService": {
            "Type": "AWS::ECS::Service",
            "Properties" : {
                "Cluster": {"Ref": "speakersCluster"},
                "DesiredCount": "1",
                "TaskDefinition" : {"Ref":"speakerCommsTaskDefinition"}
            }
        },
        "elasticIPAssociation" : {
            "Type" : "AWS::EC2::EIPAssociation",
            "Properties" : {
                "EIP" : { "Ref" : "PublicElasticIP"} ,
                "InstanceId" : {"Ref" : "speakersServer"}

            }
        }
    }
}